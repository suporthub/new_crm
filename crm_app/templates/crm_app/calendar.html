{% extends 'crm_app/base.html' %}

{% block title %}Calendar - LiveFxHub CRM{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
<style>
    .fc-event {
        cursor: pointer;
    }
    .fc-event-title {
        font-weight: 500;
    }
    .fc-daygrid-event-dot {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Calendar</h1>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Events & Tasks Calendar</h5>
            <div>
                <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                    <i class="fas fa-plus"></i> Add Task
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
                    <i class="fas fa-plus"></i> Add Event
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Tasks Notification -->
            <div id="today-tasks-notification" class="alert alert-info mb-3 d-none">
                <div class="d-flex align-items-center">
                    <i class="fas fa-bell me-2"></i>
                    <div>
                        <strong>Today's & Upcoming Tasks</strong>
                        <small class="d-block text-muted">Tasks due today or in the next 7 days</small>
                        <div id="today-tasks-list" class="mt-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Calendar Legend -->
            <div class="mb-3">
                <span class="badge bg-primary me-2">Events</span>
                <span class="badge bg-secondary me-2">Not Started</span>
                <span class="badge bg-info me-2">In Progress</span>
                <span class="badge bg-success me-2">Completed</span>
                <span class="badge bg-warning me-2">Deferred</span>
                <span class="badge bg-danger me-2">Waiting</span>
            </div>
            
            <div id="calendar"></div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="event-form">
                    <div class="mb-3">
                        <label for="title" class="form-label">Event Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_time" class="form-label">Start Time</label>
                            <input type="datetime-local" class="form-control" id="start_time" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="end_time" class="form-label">End Time</label>
                            <input type="datetime-local" class="form-control" id="end_time" name="end_time" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="all_day" name="all_day">
                            <label class="form-check-label" for="all_day">All Day Event</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" name="location">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="related_to_type" class="form-label">Related To Type</label>
                            <select class="form-select" id="related_to_type" name="related_to_type">
                                <option value="">None</option>
                                <option value="lead">Lead</option>
                                <option value="contact">Contact</option>
                                <option value="account">Account</option>
                                <option value="deal">Deal</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="related_to_id" class="form-label">Related To</label>
                            <select class="form-select" id="related_to_id" name="related_to_id" disabled>
                                <option value="">Select Related Item</option>
                                <!-- Related items will be loaded here via JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="attendees" class="form-label">Attendees</label>
                        <select class="form-select" id="attendees" name="attendees" multiple>
                            <!-- Users will be loaded here via JavaScript -->
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple attendees</small>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-event-btn">Save Event</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="event-detail-title">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="fw-bold">Date/Time:</label>
                    <div id="event-detail-datetime"></div>
                </div>
                <div class="mb-3" id="event-detail-location-container">
                    <label class="fw-bold">Location:</label>
                    <div id="event-detail-location"></div>
                </div>
                <div class="mb-3" id="event-detail-related-to-container">
                    <label class="fw-bold">Related To:</label>
                    <div id="event-detail-related-to"></div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Attendees:</label>
                    <div id="event-detail-attendees"></div>
                </div>
                <div class="mb-3" id="event-detail-description-container">
                    <label class="fw-bold">Description:</label>
                    <div id="event-detail-description"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-event-btn">Edit</button>
                <button type="button" class="btn btn-danger" id="delete-event-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
<script>
    let calendar;
    let currentEvent = null;
    
    // Load events on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeCalendar();
        loadUsers();
        
        // Set up save event button
        document.getElementById('save-event-btn').addEventListener('click', saveNewEvent);
        
        // Set up related to type change
        document.getElementById('related_to_type').addEventListener('change', function() {
            const relatedToType = this.value;
            const relatedToIdSelect = document.getElementById('related_to_id');
            
            if (relatedToType) {
                relatedToIdSelect.disabled = false;
                loadRelatedItems(relatedToType);
            } else {
                relatedToIdSelect.disabled = true;
                relatedToIdSelect.innerHTML = '<option value="">Select Related Item</option>';
            }
        });
        
        // Set up all day checkbox
        document.getElementById('all_day').addEventListener('change', function() {
            const startTimeInput = document.getElementById('start_time');
            const endTimeInput = document.getElementById('end_time');
            
            if (this.checked) {
                // Store current times
                startTimeInput.setAttribute('data-time', startTimeInput.value.split('T')[1]);
                endTimeInput.setAttribute('data-time', endTimeInput.value.split('T')[1]);
                
                // Set times to start and end of day
                const startDate = startTimeInput.value.split('T')[0];
                const endDate = endTimeInput.value.split('T')[0];
                startTimeInput.value = `${startDate}T00:00`;
                endTimeInput.value = `${endDate}T23:59`;
            } else {
                // Restore times if available
                const startDate = startTimeInput.value.split('T')[0];
                const endDate = endTimeInput.value.split('T')[0];
                const startTime = startTimeInput.getAttribute('data-time') || '09:00';
                const endTime = endTimeInput.getAttribute('data-time') || '10:00';
                startTimeInput.value = `${startDate}T${startTime}`;
                endTimeInput.value = `${endDate}T${endTime}`;
            }
        });
        
        // Set up edit event button
        document.getElementById('edit-event-btn').addEventListener('click', function() {
            if (currentEvent) {
                // Close details modal
                const detailsModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
                detailsModal.hide();
                
                // Open edit modal with event data
                editEvent(currentEvent.id);
            }
        });
        
        // Set up delete event button
        document.getElementById('delete-event-btn').addEventListener('click', function() {
            if (currentEvent) {
                if (confirm('Are you sure you want to delete this event?')) {
                    deleteEvent(currentEvent.id);
                }
            }
        });
    });
    
    // Initialize FullCalendar
    function initializeCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: fetchEvents,
            eventClick: function(info) {
                console.log('Event clicked:', info.event);
                const eventId = info.event.id;
                
                // Check if this is a task or event based on ID prefix
                if (eventId.startsWith('task_')) {
                    // Extract the numeric ID from the task_ID format
                    const taskId = eventId.replace('task_', '');
                    console.log('Opening task:', taskId);
                    viewTask(taskId);
                } else {
                    // Extract the numeric ID from the event_ID format
                    const eventNumericId = eventId.replace('event_', '');
                    console.log('Opening event:', eventNumericId);
                    showEventDetails(eventNumericId);
                }
            },
            dateClick: function(info) {
                // Open add event modal with selected date
                const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
                
                // Set default start and end times
                const startTime = new Date(info.date);
                startTime.setHours(9, 0, 0);
                
                const endTime = new Date(info.date);
                endTime.setHours(10, 0, 0);
                
                document.getElementById('start_time').value = startTime.toISOString().slice(0, 16);
                document.getElementById('end_time').value = endTime.toISOString().slice(0, 16);
                
                modal.show();
            }
        });
        
        calendar.render();
    }
    
    // Fetch events and tasks from API
    function fetchEvents(info, successCallback, failureCallback) {
        const start = info.startStr.split('T')[0];
        const end = info.endStr.split('T')[0];
        
        // Create promises for both events and tasks
        const eventsPromise = apiRequest(`events/?start_date=${start}&end_date=${end}`);
        const tasksPromise = apiRequest(`tasks/?due_date_start=${start}&due_date_end=${end}`);
        
        // Execute both promises in parallel
        Promise.all([eventsPromise, tasksPromise])
            .then(([eventsData, tasksData]) => {
                let calendarEvents = [];
                
                // Process events
                if (eventsData && eventsData.results) {
                    const events = eventsData.results.map(event => ({
                        id: `event_${event.id}`,
                        title: event.title,
                        start: event.start_time,
                        end: event.end_time,
                        allDay: event.all_day,
                        backgroundColor: '#0d6efd', // Primary color for events
                        borderColor: '#0d6efd',
                        eventType: 'event',
                        extendedProps: {
                            type: 'event',
                            location: event.location,
                            description: event.description,
                            relatedTo: event.related_to,
                            attendees: event.attendees_names
                        }
                    }));
                    calendarEvents = calendarEvents.concat(events);
                }
                
                // Process tasks
                if (tasksData && (tasksData.results || Array.isArray(tasksData))) {
                    // Get all tasks except completed ones for today
                    const today = new Date().toISOString().split('T')[0];
                    
                    const tasks = (tasksData.results || tasksData).map(task => {
                        // Check if this is a completed task for today
                        const taskDate = task.due_date.split('T')[0];
                        const isCompletedTaskForToday = task.status === 'completed' && taskDate === today;
                        
                        // If it's a completed task for today, don't show it
                        if (isCompletedTaskForToday) {
                            return null;
                        }
                        
                        return {
                            id: `task_${task.id}`,
                            title: task.subject,
                            start: task.due_date,
                            allDay: true,
                            backgroundColor: getTaskStatusColor(task.status),
                            borderColor: getTaskStatusColor(task.status),
                            eventType: 'task',
                            extendedProps: {
                                type: 'task',
                                taskId: task.id,
                                status: task.status,
                                priority: task.priority,
                                description: task.description,
                                assignedTo: task.assigned_to_name,
                                relatedTo: task.related_to
                            }
                        };
                    }).filter(task => task !== null); // Remove null entries (completed tasks for today)
                    
                    calendarEvents = calendarEvents.concat(tasks);
                }
                
                // Check for today's tasks and show notification if needed
                checkTodaysTasks(tasksData.results || tasksData || []);
                
                successCallback(calendarEvents);
            })
            .catch(error => {
                console.error('Error fetching calendar data:', error);
                failureCallback(error);
            });
    }
    
    // Check for today's tasks and upcoming tasks and show notification
    function checkTodaysTasks(tasks) {
        if (!tasks || !Array.isArray(tasks)) {
            console.log('No tasks or invalid tasks array');
            return;
        }
        
        console.log('Checking today\'s and upcoming tasks:', tasks);
        
        // Get today's date and create date objects for comparison
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayStr = today.toISOString().split('T')[0];
        console.log('Today is:', todayStr);
        
        // Calculate date 7 days from now for upcoming tasks
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 7);
        
        // Filter tasks that are not completed and are either due today or upcoming (within next 7 days)
        const relevantTasks = tasks.filter(task => {
            if (task.status === 'completed') return false;
            
            try {
                // Get task date
                const taskDate = new Date(task.due_date);
                taskDate.setHours(0, 0, 0, 0);
                
                // Check if task is due today or in the next 7 days
                const isUpcoming = taskDate >= today && taskDate <= nextWeek;
                
                console.log(`Task: ${task.subject}, due: ${task.due_date}, status: ${task.status}, isUpcoming: ${isUpcoming}`);
                return isUpcoming;
            } catch (e) {
                console.error('Error processing task date:', e);
                return false;
            }
        });
        
        console.log('Relevant tasks for notification:', relevantTasks);
        
        // Sort by date (nearest first), then by priority (high first)
        relevantTasks.sort((a, b) => {
            // First by date
            const dateA = new Date(a.due_date);
            const dateB = new Date(b.due_date);
            const dateDiff = dateA - dateB;
            if (dateDiff !== 0) return dateDiff;
            
            // Then by priority
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            return (priorityOrder[a.priority] || 99) - (priorityOrder[b.priority] || 99);
        });
        
        // Get the next 3 tasks
        const upcomingTasks = relevantTasks.slice(0, 3);
        console.log('Upcoming tasks to show:', upcomingTasks);
        
        // Get notification elements
        const notificationDiv = document.getElementById('today-tasks-notification');
        const tasksListDiv = document.getElementById('today-tasks-list');
        
        if (!notificationDiv || !tasksListDiv) {
            console.error('Notification elements not found');
            return;
        }
        
        // Clear previous content
        tasksListDiv.innerHTML = '';
        
        if (upcomingTasks.length > 0) {
            // Add tasks to the list
            upcomingTasks.forEach(task => {
                // Format the date and time
                let taskDate, taskTime, isToday;
                try {
                    const taskDateTime = new Date(task.due_date);
                    const today = new Date();
                    
                    // Check if task is due today
                    isToday = taskDateTime.toDateString() === today.toDateString();
                    
                    // Format date
                    if (isToday) {
                        taskDate = 'Today';
                    } else {
                        // Calculate days difference
                        const diffTime = taskDateTime.getTime() - today.getTime();
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 1) {
                            taskDate = 'Tomorrow';
                        } else {
                            taskDate = taskDateTime.toLocaleDateString([], {month: 'short', day: 'numeric'});
                        }
                    }
                    
                    // Format time
                    taskTime = taskDateTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } catch (e) {
                    console.error('Error formatting date/time:', e);
                    taskDate = 'Upcoming';
                    taskTime = '';
                    isToday = false;
                }
                
                // Get priority badge
                const priorityBadge = `<span class="badge bg-${getTaskPriorityColor(task.priority)}">${task.priority_display || getTaskPriorityDisplay(task.priority)}</span>`;
                
                // Create notification icon based on whether task is today or upcoming
                const notificationIcon = isToday ? 
                    `<i class="fas fa-bell text-danger me-1" title="Due today"></i>` : 
                    `<i class="fas fa-calendar-alt text-primary me-1" title="Upcoming"></i>`;
                
                // Add task to notification
                tasksListDiv.innerHTML += `
                    <div class="mt-1 ${isToday ? 'border-start border-danger border-3 ps-2' : ''}">
                        ${notificationIcon}
                        <strong>${taskDate}</strong> ${taskTime} - ${task.subject} ${priorityBadge}
                    </div>
                `;
            });
            
            // Show the notification
            notificationDiv.classList.remove('d-none');
            console.log('Notification shown');
        } else {
            // Hide the notification if no tasks
            notificationDiv.classList.add('d-none');
            console.log('No tasks for today, hiding notification');
        }
    }
    
    // Load users for dropdown
    async function loadUsers() {
        const data = await apiRequest('users/');
        if (data && data.results) {
            const attendeesSelect = document.getElementById('attendees');
            data.results.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.first_name} ${user.last_name}`;
                attendeesSelect.appendChild(option);
            });
        }
    }
    
    // Load related items based on type
    async function loadRelatedItems(type) {
        let endpoint = '';
        switch (type) {
            case 'lead': endpoint = 'leads/'; break;
            case 'contact': endpoint = 'contacts/'; break;
            case 'account': endpoint = 'accounts/'; break;
            case 'deal': endpoint = 'deals/'; break;
        }
        
        const data = await apiRequest(endpoint);
        if (data && data.results) {
            const relatedToIdSelect = document.getElementById('related_to_id');
            relatedToIdSelect.innerHTML = '<option value="">Select Related Item</option>';
            
            data.results.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // Set display text based on type
                switch (type) {
                    case 'lead':
                    case 'contact':
                        option.textContent = `${item.first_name} ${item.last_name}`;
                        break;
                    case 'account':
                    case 'deal':
                        option.textContent = item.name;
                        break;
                }
                
                relatedToIdSelect.appendChild(option);
            });
        }
    }
    
    // Save new event
    async function saveNewEvent() {
        const form = document.getElementById('event-form');
        const formData = serializeForm(form);
        
        // Handle related to fields
        const relatedToType = formData.related_to_type;
        const relatedToId = formData.related_to_id;
        
        if (relatedToType && relatedToId) {
            // Set the appropriate related entity field
            switch (relatedToType) {
                case 'lead': formData.related_lead = relatedToId; break;
                case 'contact': formData.related_contact = relatedToId; break;
                case 'account': formData.related_account = relatedToId; break;
                case 'deal': formData.related_deal = relatedToId; break;
            }
        }
        
        // Handle attendees
        const attendeesSelect = document.getElementById('attendees');
        const selectedAttendees = Array.from(attendeesSelect.selectedOptions).map(option => option.value);
        formData.attendees = selectedAttendees;
        
        // Remove helper fields
        delete formData.related_to_type;
        delete formData.related_to_id;
        
        const data = await apiRequest('events/', 'POST', formData);
        if (data) {
            // Close modal and refresh calendar
            const modal = bootstrap.Modal.getInstance(document.getElementById('addEventModal'));
            modal.hide();
            form.reset();
            calendar.refetchEvents();
            showNotification('Success', 'Event created successfully');
        }
    }
    
    // Show event details
    async function showEventDetails(eventId) {
        const data = await apiRequest(`events/${eventId}/`);
        if (data) {
            currentEvent = data;
            
            // Populate modal
            document.getElementById('event-detail-title').textContent = data.title;
            
            // Format date/time
            let dateTimeText = '';
            if (data.all_day) {
                const startDate = new Date(data.start_time).toLocaleDateString();
                const endDate = new Date(data.end_time).toLocaleDateString();
                
                if (startDate === endDate) {
                    dateTimeText = `${startDate} (All day)`;
                } else {
                    dateTimeText = `${startDate} - ${endDate} (All day)`;
                }
            } else {
                const startDateTime = formatDateTime(data.start_time);
                const endDateTime = formatDateTime(data.end_time);
                dateTimeText = `${startDateTime} - ${endDateTime}`;
            }
            document.getElementById('event-detail-datetime').textContent = dateTimeText;
            
            // Location
            const locationContainer = document.getElementById('event-detail-location-container');
            if (data.location) {
                document.getElementById('event-detail-location').textContent = data.location;
                locationContainer.style.display = 'block';
            } else {
                locationContainer.style.display = 'none';
            }
            
            // Related to
            const relatedToContainer = document.getElementById('event-detail-related-to-container');
            if (data.related_to) {
                document.getElementById('event-detail-related-to').textContent = `${data.related_to.type}: ${data.related_to.name}`;
                relatedToContainer.style.display = 'block';
            } else {
                relatedToContainer.style.display = 'none';
            }
            
            // Attendees
            const attendeesEl = document.getElementById('event-detail-attendees');
            if (data.attendees_names && data.attendees_names.length > 0) {
                attendeesEl.innerHTML = data.attendees_names.map(attendee => `<div>${attendee.name}</div>`).join('');
            } else {
                attendeesEl.textContent = 'No attendees';
            }
            
            // Description
            const descriptionContainer = document.getElementById('event-detail-description-container');
            if (data.description) {
                document.getElementById('event-detail-description').textContent = data.description;
                descriptionContainer.style.display = 'block';
            } else {
                descriptionContainer.style.display = 'none';
            }
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
            modal.show();
        }
    }
    
    // Edit event
    function editEvent(eventId) {
        // Implement edit event functionality
        console.log('Edit event:', eventId);
    }
    
    // Delete event
    async function deleteEvent(eventId) {
        const data = await apiRequest(`events/${eventId}/`, 'DELETE');
        
        // Close modal if open
        const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
        if (modal) {
            modal.hide();
        }
        
        // Refresh calendar
        calendar.refetchEvents();
        showNotification('Success', 'Event deleted successfully');
    }
    
    // View task details
    function viewTask(id) {
        try {
            // Fetch task details and show in a modal
            apiRequest(`tasks/${id}/`)
                .then(task => {
                    if (task) {
                        // Create a modal to display task details
                        const modalHtml = `
                            <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Task Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Subject:</strong></div>
                                                <div class="col-md-8">${task.subject}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Due Date:</strong></div>
                                                <div class="col-md-8">${formatDateTime(task.due_date)}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Status:</strong></div>
                                                <div class="col-md-8"><span class="badge bg-${getTaskStatusColor(task.status).replace('#', '')}">${task.status_display || getTaskStatusDisplay(task.status)}</span></div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Priority:</strong></div>
                                                <div class="col-md-8"><span class="badge bg-${getTaskPriorityColor(task.priority)}">${task.priority_display || getTaskPriorityDisplay(task.priority)}</span></div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Assigned To:</strong></div>
                                                <div class="col-md-8">${task.assigned_to_name || 'N/A'}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Related To:</strong></div>
                                                <div class="col-md-8">${getRelatedToDisplay(task.related_to)}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Description:</strong></div>
                                                <div class="col-md-8">${task.description || 'No description'}</div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary" onclick="window.location.href='/tasks/'" data-bs-dismiss="modal">Go to Tasks</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Remove any existing modal
                        const existingModal = document.getElementById('viewTaskModal');
                        if (existingModal) {
                            existingModal.remove();
                        }
                        
                        // Add the modal to the DOM
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        
                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'));
                        modal.show();
                    }
                })
                .catch(error => {
                    console.error('Error viewing task:', error);
                    showNotification('Error', 'Failed to load task details', 'danger');
                });
        } catch (error) {
            console.error('Error in viewTask function:', error);
            showNotification('Error', 'An error occurred while viewing the task', 'danger');
        }
    }
    
    // Format date time for display
    function formatDateTime(dateTimeStr) {
        try {
            const date = new Date(dateTimeStr);
            if (isNaN(date.getTime())) {
                console.warn(`Invalid date format: ${dateTimeStr}`);
                return dateTimeStr || 'N/A';
            }
            return date.toLocaleString();
        } catch (error) {
            console.error('Error formatting date:', error);
            return dateTimeStr || 'N/A';
        }
    }
    
    // Get related to display
    function getRelatedToDisplay(relatedTo) {
        if (!relatedTo) return 'N/A';
        try {
            return relatedTo.name || `${relatedTo.type}: ${relatedTo.id}`;
        } catch (error) {
            console.error('Error getting related to display:', error);
            return 'N/A';
        }
    }
    
    // Get task status color
    function getTaskStatusColor(status) {
        switch (status) {
            case 'not_started': return '#6c757d'; // secondary
            case 'in_progress': return '#0dcaf0'; // info
            case 'completed': return '#198754';   // success
            case 'deferred': return '#ffc107';    // warning
            case 'waiting': return '#dc3545';     // danger
            default: return '#6c757d';           // secondary
        }
    }
    
    // Get task priority color
    function getTaskPriorityColor(priority) {
        switch (priority) {
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'secondary';
        }
    }
    
    // Get task status display
    function getTaskStatusDisplay(status) {
        switch (status) {
            case 'not_started': return 'Not Started';
            case 'in_progress': return 'In Progress';
            case 'completed': return 'Completed';
            case 'deferred': return 'Deferred';
            case 'waiting': return 'Waiting';
            default: return status;
        }
    }
    
    // Get task priority display
    function getTaskPriorityDisplay(priority) {
        switch (priority) {
            case 'high': return 'High';
            case 'medium': return 'Medium';
            case 'low': return 'Low';
            default: return priority;
        }
    }
</script>
{% endblock %}
