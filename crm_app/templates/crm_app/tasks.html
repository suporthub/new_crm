{% extends 'crm_app/base.html' %}

{% block title %}Tasks - LiveFxHub CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Tasks</h1>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">My Tasks <span class="badge bg-primary ms-2" id="task-count">0</span></h5>
                <small class="text-muted">Showing tasks assigned to you</small>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fas fa-plus"></i> Add Task
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="not_started">Not Started</button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="in_progress">In Progress</button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="completed">Completed</button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="deferred">Deferred</button>
                    <button type="button" class="btn btn-outline-secondary" data-filter="waiting">Waiting</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="tasks-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Priority</th>
                            <th>Assigned To</th>
                            <th>Related To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Tasks will be loaded here via JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Loading tasks...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="task-form">
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="due_date" class="form-label">Due Date</label>
                            <input type="datetime-local" class="form-control" id="due_date" name="due_date" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="not_started">Not Started</option>
                                <option value="in_progress">In Progress</option>
                                <option value="completed">Completed</option>
                                <option value="deferred">Deferred</option>
                                <option value="waiting">Waiting on Someone Else</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">Priority</label>
                            <select class="form-select" id="priority" name="priority">
                                <option value="high">High</option>
                                <option value="medium" selected>Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="assigned_to" class="form-label">Assigned To</label>
                            <select class="form-select" id="assigned_to" name="assigned_to" required>
                                <option value="">Loading users...</option>
                                <!-- Users will be loaded dynamically -->
                            </select>
                            <small class="text-muted">Select a user to assign this task</small>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="related_to_type" class="form-label">Related To Type</label>
                            <select class="form-select" id="related_to_type" name="related_to_type">
                                <option value="">None</option>
                                <option value="lead">Lead</option>
                                <option value="contact">Contact</option>
                                <option value="account">Account</option>
                                <option value="deal">Deal</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="related_to_id" class="form-label">Related To</label>
                            <select class="form-select" id="related_to_id" name="related_to_id" disabled>
                                <option value="">Select Related Item</option>
                                <!-- Related items will be loaded here via JavaScript -->
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-task-btn">Save Task</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load tasks on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadTasks();
        loadUsers();
        
        // Set up save task button
        document.getElementById('save-task-btn').addEventListener('click', saveNewTask);
        
        // Set up filter buttons
        document.querySelectorAll('[data-filter]').forEach(button => {
            button.addEventListener('click', function() {
                // Update active button
                document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // Filter tasks
                const filter = this.getAttribute('data-filter');
                if (filter === 'all') {
                    loadTasks();
                } else {
                    loadTasks(filter);
                }
            });
        });
        
        // Set up related to type change
        document.getElementById('related_to_type').addEventListener('change', function() {
            const relatedToType = this.value;
            const relatedToIdSelect = document.getElementById('related_to_id');
            
            if (relatedToType) {
                relatedToIdSelect.disabled = false;
                loadRelatedItems(relatedToType);
            } else {
                relatedToIdSelect.disabled = true;
                relatedToIdSelect.innerHTML = '<option value="">Select Related Item</option>';
            }
        });
        
        // Set default due date to tomorrow
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        document.getElementById('due_date').value = tomorrow.toISOString().slice(0, 16);
        
        // Initialize tooltips for static elements
        initTooltips();
    });
    
    // Function to initialize tooltips
    function initTooltips() {
        // Initialize Bootstrap tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
    
    // Load tasks from API - only shows current user's tasks
    async function loadTasks(status = null) {
        try {
            // Build the URL with parameters
            let url = 'tasks/';
            let params = [];
            
            // Add status filter if provided
            if (status && status !== 'all') {
                params.push(`status=${status}`);
            }
            
            // Add parameters to URL if any exist
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            console.log('Fetching tasks from:', url);
            const data = await apiRequest(url);
            console.log('Tasks API response:', data);
            
            if (data && data.results) {
                console.log('Found tasks:', data.results.length);
                populateTasksTable(data.results);
                updateTaskCounter(data.results.length);
            } else if (data && Array.isArray(data)) {
                // Handle case where data is returned as an array instead of paginated results
                console.log('Found tasks (array):', data.length);
                populateTasksTable(data);
                updateTaskCounter(data.length);
            } else {
                console.error('No tasks found or invalid data format');
                document.getElementById('tasks-table').getElementsByTagName('tbody')[0].innerHTML = 
                    '<tr><td colspan="7" class="text-center">No tasks found</td></tr>';
                updateTaskCounter(0);
            }
        } catch (error) {
            console.error('Error loading tasks:', error);
            document.getElementById('tasks-table').getElementsByTagName('tbody')[0].innerHTML = 
                '<tr><td colspan="7" class="text-center">Error loading tasks: ' + error.message + '</td></tr>';
            updateTaskCounter(0);
        }
    }
    
    // Update task counter
    function updateTaskCounter(count) {
        const taskCountElement = document.getElementById('task-count');
        if (taskCountElement) {
            taskCountElement.textContent = count;
        }
    }
    
    // Load users for the assigned_to dropdown with filtering based on manager
    async function loadUsers() {
        try {
            // Get the current user for the default selection
            const currentUser = await apiRequest('current-user/');
            console.log('Current user data:', currentUser);
            
            // Use the new API endpoint to get filtered users based on manager relationship
            const usersResponse = await apiRequest('users-by-manager/');
            console.log('Users by manager data:', usersResponse);
            
            // Get the users array from the response
            const users = usersResponse.results || usersResponse;
            
            // Get the dropdown element
            const userSelect = document.getElementById('assigned_to');
            userSelect.innerHTML = '<option value="">Select User</option>';
            
            // Add the current user as the first option
            if (currentUser) {
                const currentUserOption = document.createElement('option');
                currentUserOption.value = currentUser.id;
                currentUserOption.textContent = `${currentUser.first_name || ''} ${currentUser.last_name || ''} (${currentUser.username || ''}) - Current User`;
                currentUserOption.selected = true; // Select by default
                userSelect.appendChild(currentUserOption);
            }
            
            // Add other users from the filtered API response
            if (users && users.length > 0) {
                users.forEach(user => {
                    // Skip the current user as we've already added them
                    if (currentUser && user.id === currentUser.id) {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.first_name || ''} ${user.last_name || ''} (${user.username || ''})`;
                    userSelect.appendChild(option);
                });
                
                console.log('Added users to dropdown:', users.length);
            } else {
                console.log('No additional users found or available');
            }
            
        } catch (error) {
            console.error('Error loading users:', error);
            // Show an error message in the dropdown
            const userSelect = document.getElementById('assigned_to');
            userSelect.innerHTML = '<option value="">Error loading users</option>';
            
            // Show notification
            showNotification('Error', 'Could not load user information. Please refresh the page.', 'danger');
        }
    }
    
    // Load related items based on type
    async function loadRelatedItems(type) {
        try {
            // First, get the current user to determine role and manager
            const currentUser = await apiRequest('current-user/');
            console.log('Current user data:', currentUser);
            
            // Clear and prepare the dropdown
            const relatedToIdSelect = document.getElementById('related_to_id');
            relatedToIdSelect.innerHTML = '<option value="">Loading items...</option>';
            relatedToIdSelect.disabled = true;
            
            // Determine the endpoint based on type
            let endpoint = '';
            switch (type) {
                case 'lead': endpoint = 'leads/'; break;
                case 'contact': endpoint = 'contacts/'; break;
                case 'account': endpoint = 'accounts/'; break;
                case 'deal': endpoint = 'deals/'; break;
                default: 
                    relatedToIdSelect.innerHTML = '<option value="">Invalid type</option>';
                    return;
            }
            
            // Add filter parameter if the user is a manager
            // This assumes your API supports filtering by manager_username
            if (currentUser && currentUser.profile && currentUser.profile.role === 'manager') {
                endpoint += `?manager=${currentUser.username}`;
                console.log(`Filtering ${type} by manager:`, currentUser.username);
            } 
            // If user has a manager, filter by their manager
            else if (currentUser && currentUser.profile && currentUser.profile.manager_username) {
                endpoint += `?manager=${currentUser.profile.manager_username}`;
                console.log(`Filtering ${type} by user's manager:`, currentUser.profile.manager_username);
            }
            
            console.log(`Fetching from endpoint: ${endpoint}`);
            const data = await apiRequest(endpoint);
            console.log(`${type} data:`, data);
            
            // Reset dropdown
            relatedToIdSelect.innerHTML = '<option value="">Select Related Item</option>';
            relatedToIdSelect.disabled = false;
            
            // Process the data
            const items = data.results || data;
            if (!items || items.length === 0) {
                const option = document.createElement('option');
                option.value = "";
                option.textContent = "No items available";
                option.disabled = true;
                relatedToIdSelect.appendChild(option);
                return;
            }
            
            // Add items to dropdown
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                
                // Set display text based on type
                switch (type) {
                    case 'lead':
                        option.textContent = `${item.first_name || ''} ${item.last_name || ''} (${item.email || 'No email'})`;
                        break;
                    case 'contact':
                        option.textContent = `${item.first_name || ''} ${item.last_name || ''} (${item.email || 'No email'})`;
                        break;
                    case 'account':
                        option.textContent = `${item.name || ''} (${item.website || 'No website'})`;
                        break;
                    case 'deal':
                        option.textContent = `${item.name || ''} ($${item.amount || '0'})`;
                        break;
                }
                
                relatedToIdSelect.appendChild(option);
            });
            
            console.log(`Added ${items.length} items to dropdown`);
            
        } catch (error) {
            console.error(`Error loading ${type}:`, error);
            const relatedToIdSelect = document.getElementById('related_to_id');
            relatedToIdSelect.innerHTML = '<option value="">Error loading items</option>';
            relatedToIdSelect.disabled = false;
        }
    }
    
    // Helper function to serialize form data
    function serializeForm(form) {
        const formData = {};
        const formElements = form.elements;
        
        for (let i = 0; i < formElements.length; i++) {
            const element = formElements[i];
            if (element.name && element.value) {
                formData[element.name] = element.value;
            }
        }
        
        return formData;
    }
    
    // Populate tasks table
    function populateTasksTable(tasks) {
        const tableBody = document.getElementById('tasks-table').getElementsByTagName('tbody')[0];
        if (!tasks || tasks.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No tasks found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        tasks.forEach(task => {
            try {
                // Log task data for debugging
                console.log('Processing task:', task);
                
                // Create a safe version of the task with default values for missing properties
                const safeTask = {
                    id: task.id || 0,
                    subject: task.subject || 'Untitled Task',
                    due_date: task.due_date || new Date().toISOString(),
                    status: task.status || 'not_started',
                    status_display: task.status_display || '',
                    priority: task.priority || 'medium',
                    priority_display: task.priority_display || '',
                    assigned_to_name: task.assigned_to_name || 'N/A',
                    related_to: task.related_to || null
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${safeTask.subject}</td>
                    <td>${formatDateTime(safeTask.due_date)}</td>
                    <td><span class="badge bg-${getTaskStatusColor(safeTask.status)}">${safeTask.status_display || getTaskStatusDisplay(safeTask.status)}</span></td>
                    <td><span class="badge bg-${getTaskPriorityColor(safeTask.priority)}">${safeTask.priority_display || getTaskPriorityDisplay(safeTask.priority)}</span></td>
                    <td>${safeTask.assigned_to_name}</td>
                    <td>${getRelatedToDisplay(safeTask.related_to)}</td>
                    <td>
                        <button class="btn btn-sm btn-info me-1" onclick="viewTask(${safeTask.id})" data-bs-toggle="tooltip" title="View Task">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-primary me-1" onclick="editTask(${safeTask.id})" data-bs-toggle="tooltip" title="Edit Task">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-success me-1" onclick="markTaskComplete(${safeTask.id})" ${safeTask.status === 'completed' ? 'disabled' : ''} data-bs-toggle="tooltip" title="${safeTask.status === 'completed' ? 'Task Already Completed' : 'Mark as Complete'}">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTask(${safeTask.id})" data-bs-toggle="tooltip" title="Delete Task">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            } catch (error) {
                console.error('Error processing task:', error, task);
                // Skip this task and continue with others
            }
        });
        
        // Initialize tooltips for the newly added buttons
        initTooltips();
    }
    
    // Save new task or update existing task
    async function saveNewTask() {
        try {
            const form = document.getElementById('task-form');
            const formData = serializeForm(form);
            
            // Get the assigned_to value directly from the dropdown
            const assignedToSelect = document.getElementById('assigned_to');
            const assignedToValue = assignedToSelect.value;
            
            // Use the selected value for assigned_to
            formData.assigned_to = parseInt(assignedToValue, 10);
            console.log('Using assigned_to value from dropdown:', formData.assigned_to);
            
            // Validate that we have a valid assigned_to value
            if (!formData.assigned_to || isNaN(formData.assigned_to)) {
                // Show error message
                showNotification('Error', 'Please select a user to assign this task to.', 'danger');
                return;
            }
            
            // Handle related to fields
            const relatedToType = formData.related_to_type;
            const relatedToId = formData.related_to_id;
            
            if (relatedToType && relatedToId) {
                // Set the appropriate related entity field
                switch (relatedToType) {
                    case 'lead': formData.related_lead = relatedToId; break;
                    case 'contact': formData.related_contact = relatedToId; break;
                    case 'account': formData.related_account = relatedToId; break;
                    case 'deal': formData.related_deal = relatedToId; break;
                }
            }
            
            // Remove helper fields
            delete formData.related_to_type;
            delete formData.related_to_id;
            
            // Check if we're editing an existing task or creating a new one
            const saveButton = document.getElementById('save-task-btn');
            const taskId = saveButton.getAttribute('data-task-id');
            
            let url = 'tasks/';
            let method = 'POST';
            let successMessage = 'Task created successfully';
            
            if (taskId) {
                // We're updating an existing task
                url = `tasks/${taskId}/`;
                method = 'PUT';
                successMessage = 'Task updated successfully';
            }
            
            const data = await apiRequest(url, method, formData);
            if (data) {
                // Close modal and reload tasks
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                modal.hide();
                
                // Reset the form and save button
                form.reset();
                saveButton.removeAttribute('data-task-id');
                saveButton.textContent = 'Save Task';
                
                // Reset modal title
                const modalTitle = document.getElementById('addTaskModal').querySelector('.modal-title');
                modalTitle.textContent = 'Add New Task';
                
                // Reload tasks and show notification
                loadTasks();
                showNotification('Success', successMessage, 'success');
            }
        } catch (error) {
            console.error('Error saving task:', error);
            showNotification('Error', 'Failed to save task', 'danger');
        }
    }
    
    // Helper function for task status color
    function getTaskStatusColor(status) {
        switch (status) {
            case 'not_started': return 'secondary';
            case 'in_progress': return 'primary';
            case 'completed': return 'success';
            case 'deferred': return 'warning';
            case 'waiting': return 'info';
            default: return 'secondary';
        }
    }
    
    // Helper function for task status display
    function getTaskStatusDisplay(status) {
        switch (status) {
            case 'not_started': return 'Not Started';
            case 'in_progress': return 'In Progress';
            case 'completed': return 'Completed';
            case 'deferred': return 'Deferred';
            case 'waiting': return 'Waiting';
            default: return status;
        }
    }
    
    // Helper function for task priority color
    function getTaskPriorityColor(priority) {
        switch (priority) {
            case 'high': return 'danger';
            case 'medium': return 'warning';
            case 'low': return 'info';
            default: return 'secondary';
        }
    }
    
    // Helper function for task priority display
    function getTaskPriorityDisplay(priority) {
        switch (priority) {
            case 'high': return 'High';
            case 'medium': return 'Medium';
            case 'low': return 'Low';
            default: return priority;
        }
    }
    
    // Helper function for related to display
    function getRelatedToDisplay(relatedTo) {
        try {
            if (!relatedTo) return 'N/A';
            if (typeof relatedTo !== 'object') return 'N/A';
            
            const type = relatedTo.type || 'Unknown';
            const name = relatedTo.name || 'Unknown';
            return `${type}: ${name}`;
        } catch (error) {
            console.error('Error displaying related to:', error, relatedTo);
            return 'N/A';
        }
    }
    
    // View task details
    function viewTask(id) {
        try {
            // Fetch task details and show in a modal
            apiRequest(`tasks/${id}/`)
                .then(task => {
                    if (task) {
                        // Create a modal to display task details
                        const modalHtml = `
                            <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Task Details</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Subject:</strong></div>
                                                <div class="col-md-8">${task.subject}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Due Date:</strong></div>
                                                <div class="col-md-8">${formatDateTime(task.due_date)}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Status:</strong></div>
                                                <div class="col-md-8"><span class="badge bg-${getTaskStatusColor(task.status)}">${task.status_display || getTaskStatusDisplay(task.status)}</span></div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Priority:</strong></div>
                                                <div class="col-md-8"><span class="badge bg-${getTaskPriorityColor(task.priority)}">${task.priority_display || getTaskPriorityDisplay(task.priority)}</span></div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Assigned To:</strong></div>
                                                <div class="col-md-8">${task.assigned_to_name || 'N/A'}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Related To:</strong></div>
                                                <div class="col-md-8">${getRelatedToDisplay(task.related_to)}</div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-4"><strong>Description:</strong></div>
                                                <div class="col-md-8">${task.description || 'No description'}</div>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            <button type="button" class="btn btn-primary" onclick="editTask(${task.id})" data-bs-dismiss="modal">Edit Task</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // Remove any existing modal
                        const existingModal = document.getElementById('viewTaskModal');
                        if (existingModal) {
                            existingModal.remove();
                        }
                        
                        // Add the modal to the DOM
                        document.body.insertAdjacentHTML('beforeend', modalHtml);
                        
                        // Show the modal
                        const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'));
                        modal.show();
                    }
                })
                .catch(error => {
                    console.error('Error viewing task:', error);
                    showNotification('Error', 'Failed to load task details', 'danger');
                });
        } catch (error) {
            console.error('Error in viewTask function:', error);
            showNotification('Error', 'An error occurred while viewing the task', 'danger');
        }
    }
    
    // Edit task
    function editTask(id) {
        try {
            // First load users to populate the dropdown
            loadUsers().then(() => {
                // Fetch task details and populate the edit form
                apiRequest(`tasks/${id}/`)
                    .then(task => {
                        if (task) {
                            // Get the modal and populate it
                            const modal = document.getElementById('addTaskModal');
                            const modalTitle = modal.querySelector('.modal-title');
                            modalTitle.textContent = 'Edit Task';
                            
                            // Populate form fields
                            document.getElementById('subject').value = task.subject || '';
                            if (task.due_date) {
                                const dueDate = new Date(task.due_date);
                                document.getElementById('due_date').value = dueDate.toISOString().slice(0, 16);
                            }
                            document.getElementById('status').value = task.status || 'not_started';
                            document.getElementById('priority').value = task.priority || 'medium';
                            document.getElementById('description').value = task.description || '';
                            
                            // Set the assigned_to field
                            console.log('Task assigned_to:', task.assigned_to);
                            if (task.assigned_to) {
                                // Wait a short time to ensure the dropdown is populated
                                setTimeout(() => {
                                    const assignedToSelect = document.getElementById('assigned_to');
                                    
                                    // Find and select the option with the matching value
                                    for (let i = 0; i < assignedToSelect.options.length; i++) {
                                        if (assignedToSelect.options[i].value == task.assigned_to) {
                                            assignedToSelect.selectedIndex = i;
                                            console.log(`Selected user at index ${i}:`, assignedToSelect.options[i].textContent);
                                            break;
                                        }
                                    }
                                    
                                    // If we couldn't find the user in the dropdown, try to get their details
                                    if (assignedToSelect.value != task.assigned_to) {
                                        console.log('User not found in dropdown, fetching details...');
                                        apiRequest(`users/${task.assigned_to}/`)
                                            .then(userData => {
                                                if (userData) {
                                                    // Add this user to the dropdown
                                                    const option = document.createElement('option');
                                                    option.value = userData.id;
                                                    option.textContent = `${userData.first_name || ''} ${userData.last_name || ''} (${userData.username || ''})`;
                                                    assignedToSelect.appendChild(option);
                                                    option.selected = true;
                                                }
                                            })
                                            .catch(error => {
                                                console.error('Error fetching user details:', error);
                                            });
                                    }
                                }, 300);
                            }
                            
                            // Handle related_to fields
                            if (task.related_to) {
                                const relatedToType = document.getElementById('related_to_type');
                                relatedToType.value = task.related_to.type;
                                
                                // Load related items and then set the value
                                loadRelatedItems(task.related_to.type).then(() => {
                                    const relatedToId = document.getElementById('related_to_id');
                                    relatedToId.disabled = false;
                                    relatedToId.value = task.related_to.id;
                                });
                            }
                            
                            // Update the save button to handle edit
                            const saveButton = document.getElementById('save-task-btn');
                            saveButton.setAttribute('data-task-id', task.id);
                            saveButton.textContent = 'Update Task';
                            
                            // Show the modal
                            const taskModal = new bootstrap.Modal(modal);
                            taskModal.show();
                        }
                    })
                    .catch(error => {
                        console.error('Error editing task:', error);
                        showNotification('Error', 'Failed to load task for editing', 'danger');
                    });
            });
        } catch (error) {
            console.error('Error in editTask function:', error);
            showNotification('Error', 'An error occurred while editing the task', 'danger');
        }
    }
    
    // Mark task as complete
    function markTaskComplete(id) {
        try {
            apiRequest(`tasks/${id}/mark_complete/`, 'POST')
                .then(data => {
                    if (data) {
                        loadTasks();
                        showNotification('Success', 'Task marked as complete', 'success');
                    }
                })
                .catch(error => {
                    console.error('Error completing task:', error);
                    showNotification('Error', 'Failed to mark task as complete', 'danger');
                });
        } catch (error) {
            console.error('Error in markTaskComplete function:', error);
            showNotification('Error', 'An error occurred while completing the task', 'danger');
        }
    }
    
    // Delete task
    function deleteTask(id) {
        try {
            if (confirm('Are you sure you want to delete this task?')) {
                apiRequest(`tasks/${id}/`, 'DELETE')
                    .then(() => {
                        loadTasks();
                        showNotification('Success', 'Task deleted successfully', 'success');
                    })
                    .catch(error => {
                        console.error('Error deleting task:', error);
                        showNotification('Error', 'Failed to delete task', 'danger');
                    });
            }
        } catch (error) {
            console.error('Error in deleteTask function:', error);
            showNotification('Error', 'An error occurred while deleting the task', 'danger');
        }
    }
</script>
{% endblock %}
