{% extends 'crm_app/base.html' %}

{% block title %}Settings - LiveFxHub CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Settings</h1>
    
    <div class="row">
        <!-- Settings Navigation -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Settings Menu</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#general" class="list-group-item list-group-item-action active" data-bs-toggle="list">General Settings</a>
                    <a href="#profile" class="list-group-item list-group-item-action" data-bs-toggle="list">Profile Settings</a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">Notification Settings</a>
                    <a href="#security" class="list-group-item list-group-item-action" data-bs-toggle="list">Security Settings</a>
                    <a href="#appearance" class="list-group-item list-group-item-action" data-bs-toggle="list">Appearance Settings</a>
                    <a href="#integrations" class="list-group-item list-group-item-action" data-bs-toggle="list">Integrations</a>
                </div>
            </div>
        </div>
        
        <!-- Settings Content -->
        <div class="col-md-9">
            <div class="tab-content">
                <!-- General Settings -->
                <div class="tab-pane fade show active" id="general">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">General Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="general-settings-form">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Timezone</label>
                                    <select class="form-select" id="timezone" name="timezone">
                                        <option value="UTC">UTC</option>
                                        <option value="Asia/Kolkata" selected>Asia/Kolkata (IST)</option>
                                        <option value="America/New_York">America/New_York (EST)</option>
                                        <option value="Europe/London">Europe/London (GMT)</option>
                                        <option value="Europe/Paris">Europe/Paris (CET)</option>
                                        <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="date_format" class="form-label">Date Format</label>
                                    <select class="form-select" id="date_format" name="date_format">
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="DD/MM/YYYY" selected>DD/MM/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="time_format" class="form-label">Time Format</label>
                                    <select class="form-select" id="time_format" name="time_format">
                                        <option value="12h">12 Hour (AM/PM)</option>
                                        <option value="24h" selected>24 Hour</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language" name="language">
                                        <option value="en" selected>English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="hi">Hindi</option>
                                    </select>
                                </div>
                                <button type="button" class="btn btn-primary" id="save-general-settings">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Profile Settings -->
                <div class="tab-pane fade" id="profile">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Profile Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="profile-settings-form">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name">
                                </div>
                                <div class="mb-3">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name">
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" name="email">
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="phone" name="phone">
                                </div>
                                <div class="mb-3">
                                    <label for="profile_picture" class="form-label">Profile Picture</label>
                                    <input type="file" class="form-control" id="profile_picture" name="profile_picture">
                                </div>
                                <button type="button" class="btn btn-primary" id="save-profile-settings">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Notification Settings -->
                <div class="tab-pane fade" id="notifications">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Notification Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="notification-settings-form">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="email_notifications" checked>
                                        <label class="form-check-label" for="email_notifications">Email Notifications</label>
                                    </div>
                                    <small class="text-muted">Receive notifications via email</small>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="browser_notifications" checked>
                                        <label class="form-check-label" for="browser_notifications">Browser Notifications</label>
                                    </div>
                                    <small class="text-muted">Receive notifications in your browser</small>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="task_reminders" checked>
                                        <label class="form-check-label" for="task_reminders">Task Reminders</label>
                                    </div>
                                    <small class="text-muted">Receive reminders for upcoming tasks</small>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="deal_updates" checked>
                                        <label class="form-check-label" for="deal_updates">Deal Updates</label>
                                    </div>
                                    <small class="text-muted">Receive notifications when deals are updated</small>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="lead_notifications" checked>
                                        <label class="form-check-label" for="lead_notifications">Lead Notifications</label>
                                    </div>
                                    <small class="text-muted">Receive notifications for new leads</small>
                                </div>
                                <button type="button" class="btn btn-primary" id="save-notification-settings">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Security Settings -->
                <div class="tab-pane fade" id="security">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Security Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="security-settings-form">
                                <div class="mb-4">
                                    <h6>Change Password</h6>
                                    <div class="mb-3">
                                        <label for="current_password" class="form-label">Current Password</label>
                                        <input type="password" class="form-control" id="current_password" name="current_password">
                                    </div>
                                    <div class="mb-3">
                                        <label for="new_password" class="form-label">New Password</label>
                                        <input type="password" class="form-control" id="new_password" name="new_password">
                                    </div>
                                    <div class="mb-3">
                                        <label for="confirm_password" class="form-label">Confirm New Password</label>
                                        <input type="password" class="form-control" id="confirm_password" name="confirm_password">
                                    </div>
                                    <button type="button" class="btn btn-primary" id="change-password">Update Password</button>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-4">
                                    <h6>Two-Factor Authentication</h6>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="two_factor_auth">
                                            <label class="form-check-label" for="two_factor_auth">Enable Two-Factor Authentication</label>
                                        </div>
                                        <small class="text-muted">Enhance your account security with two-factor authentication</small>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="setup-2fa" disabled>Set Up Two-Factor Authentication</button>
                                </div>
                                
                                <hr>
                                
                                <div class="mb-4">
                                    <h6>Session Management</h6>
                                    <div class="mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="auto_logout" checked>
                                            <label class="form-check-label" for="auto_logout">Auto Logout</label>
                                        </div>
                                        <small class="text-muted">Automatically log out after period of inactivity</small>
                                    </div>
                                    <div class="mb-3">
                                        <label for="session_timeout" class="form-label">Session Timeout (minutes)</label>
                                        <select class="form-select" id="session_timeout" name="session_timeout">
                                            <option value="15">15 minutes</option>
                                            <option value="30" selected>30 minutes</option>
                                            <option value="60">1 hour</option>
                                            <option value="120">2 hours</option>
                                            <option value="240">4 hours</option>
                                        </select>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="save-session-settings">Save Session Settings</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Appearance Settings -->
                <div class="tab-pane fade" id="appearance">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Appearance Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="appearance-settings-form">
                                <div class="mb-3">
                                    <label class="form-label">Theme</label>
                                    <div class="d-flex gap-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="theme" id="theme_light" value="light" checked>
                                            <label class="form-check-label" for="theme_light">
                                                Light
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="theme" id="theme_dark" value="dark">
                                            <label class="form-check-label" for="theme_dark">
                                                Dark
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="theme" id="theme_system" value="system">
                                            <label class="form-check-label" for="theme_system">
                                                System Default
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="color_scheme" class="form-label">Color Scheme</label>
                                    <select class="form-select" id="color_scheme" name="color_scheme">
                                        <option value="blue" selected>Blue (Default)</option>
                                        <option value="green">Green</option>
                                        <option value="purple">Purple</option>
                                        <option value="orange">Orange</option>
                                        <option value="red">Red</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="font_size" class="form-label">Font Size</label>
                                    <select class="form-select" id="font_size" name="font_size">
                                        <option value="small">Small</option>
                                        <option value="medium" selected>Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="compact_view">
                                        <label class="form-check-label" for="compact_view">Compact View</label>
                                    </div>
                                    <small class="text-muted">Display more information in less space</small>
                                </div>
                                <button type="button" class="btn btn-primary" id="save-appearance-settings">Save Changes</button>
                                <button type="button" class="btn btn-outline-secondary" id="reset-appearance">Reset to Default</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Integrations -->
                <div class="tab-pane fade" id="integrations">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Integrations</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">Google Calendar</h6>
                                        <small class="text-muted">Sync your events with Google Calendar</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">Connect</button>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">Microsoft Outlook</h6>
                                        <small class="text-muted">Sync your emails and calendar with Outlook</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">Connect</button>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">Slack</h6>
                                        <small class="text-muted">Receive notifications in your Slack workspace</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">Connect</button>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">Zapier</h6>
                                        <small class="text-muted">Connect with thousands of apps through Zapier</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">Connect</button>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                            
                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <h6 class="mb-0">QuickBooks</h6>
                                        <small class="text-muted">Sync financial data with QuickBooks</small>
                                    </div>
                                    <button class="btn btn-sm btn-outline-primary">Connect</button>
                                </div>
                                <div class="progress" style="height: 5px;">
                                    <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load user settings
        loadUserSettings();
        
        // Set up event listeners for save buttons
        document.getElementById('save-general-settings').addEventListener('click', saveGeneralSettings);
        document.getElementById('save-profile-settings').addEventListener('click', saveProfileSettings);
        document.getElementById('save-notification-settings').addEventListener('click', saveNotificationSettings);
        document.getElementById('change-password').addEventListener('click', changePassword);
        document.getElementById('save-session-settings').addEventListener('click', saveSessionSettings);
        document.getElementById('save-appearance-settings').addEventListener('click', saveAppearanceSettings);
        document.getElementById('reset-appearance').addEventListener('click', resetAppearanceSettings);
        
        // Toggle 2FA setup button based on checkbox
        document.getElementById('two_factor_auth').addEventListener('change', function() {
            document.getElementById('setup-2fa').disabled = !this.checked;
        });
    });
    
    // Load user settings from API
    async function loadUserSettings() {
        try {
            // Fetch user settings
            const settings = await apiRequest('settings/');
            console.log('User settings:', settings);
            
            // Populate form fields with user settings
            if (settings) {
                // General settings
                if (settings.general) {
                    document.getElementById('timezone').value = settings.general.timezone || 'Asia/Kolkata';
                    document.getElementById('date_format').value = settings.general.date_format || 'DD/MM/YYYY';
                    document.getElementById('time_format').value = settings.general.time_format || '24h';
                    document.getElementById('language').value = settings.general.language || 'en';
                }
                
                // Profile settings
                if (settings.profile) {
                    document.getElementById('first_name').value = settings.profile.first_name || '';
                    document.getElementById('last_name').value = settings.profile.last_name || '';
                    document.getElementById('email').value = settings.profile.email || '';
                    document.getElementById('phone').value = settings.profile.phone || '';
                }
                
                // Notification settings
                if (settings.notifications) {
                    document.getElementById('email_notifications').checked = settings.notifications.email_notifications !== false;
                    document.getElementById('browser_notifications').checked = settings.notifications.browser_notifications !== false;
                    document.getElementById('task_reminders').checked = settings.notifications.task_reminders !== false;
                    document.getElementById('deal_updates').checked = settings.notifications.deal_updates !== false;
                    document.getElementById('lead_notifications').checked = settings.notifications.lead_notifications !== false;
                }
                
                // Security settings
                if (settings.security) {
                    document.getElementById('two_factor_auth').checked = settings.security.two_factor_auth === true;
                    document.getElementById('setup-2fa').disabled = !settings.security.two_factor_auth;
                    document.getElementById('auto_logout').checked = settings.security.auto_logout !== false;
                    document.getElementById('session_timeout').value = settings.security.session_timeout || '30';
                }
                
                // Appearance settings
                if (settings.appearance) {
                    const themeRadio = document.querySelector(`input[name="theme"][value="${settings.appearance.theme || 'light'}"]`);
                    if (themeRadio) themeRadio.checked = true;
                    
                    document.getElementById('color_scheme').value = settings.appearance.color_scheme || 'blue';
                    document.getElementById('font_size').value = settings.appearance.font_size || 'medium';
                    document.getElementById('compact_view').checked = settings.appearance.compact_view === true;
                }
            }
        } catch (error) {
            console.error('Error loading user settings:', error);
            showNotification('Error', 'Failed to load user settings', 'danger');
        }
    }
    
    // Save general settings
    async function saveGeneralSettings() {
        try {
            const generalSettings = {
                timezone: document.getElementById('timezone').value,
                date_format: document.getElementById('date_format').value,
                time_format: document.getElementById('time_format').value,
                language: document.getElementById('language').value
            };
            
            const response = await apiRequest('settings/general/', 'PUT', generalSettings);
            if (response) {
                showNotification('Success', 'General settings saved successfully', 'success');
            }
        } catch (error) {
            console.error('Error saving general settings:', error);
            showNotification('Error', 'Failed to save general settings', 'danger');
        }
    }
    
    // Save profile settings
    async function saveProfileSettings() {
        try {
            const profileSettings = {
                first_name: document.getElementById('first_name').value,
                last_name: document.getElementById('last_name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value
            };
            
            const response = await apiRequest('settings/profile/', 'PUT', profileSettings);
            if (response) {
                showNotification('Success', 'Profile settings saved successfully', 'success');
            }
        } catch (error) {
            console.error('Error saving profile settings:', error);
            showNotification('Error', 'Failed to save profile settings', 'danger');
        }
    }
    
    // Save notification settings
    async function saveNotificationSettings() {
        try {
            const notificationSettings = {
                email_notifications: document.getElementById('email_notifications').checked,
                browser_notifications: document.getElementById('browser_notifications').checked,
                task_reminders: document.getElementById('task_reminders').checked,
                deal_updates: document.getElementById('deal_updates').checked,
                lead_notifications: document.getElementById('lead_notifications').checked
            };
            
            const response = await apiRequest('settings/notifications/', 'PUT', notificationSettings);
            if (response) {
                showNotification('Success', 'Notification settings saved successfully', 'success');
            }
        } catch (error) {
            console.error('Error saving notification settings:', error);
            showNotification('Error', 'Failed to save notification settings', 'danger');
        }
    }
    
    // Change password
    async function changePassword() {
        try {
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            // Validate passwords
            if (!currentPassword) {
                showNotification('Error', 'Please enter your current password', 'danger');
                return;
            }
            
            if (!newPassword) {
                showNotification('Error', 'Please enter a new password', 'danger');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showNotification('Error', 'New passwords do not match', 'danger');
                return;
            }
            
            const passwordData = {
                current_password: currentPassword,
                new_password: newPassword
            };
            
            const response = await apiRequest('change-password/', 'POST', passwordData);
            if (response) {
                showNotification('Success', 'Password changed successfully', 'success');
                
                // Clear password fields
                document.getElementById('current_password').value = '';
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_password').value = '';
            }
        } catch (error) {
            console.error('Error changing password:', error);
            showNotification('Error', 'Failed to change password', 'danger');
        }
    }
    
    // Save session settings
    async function saveSessionSettings() {
        try {
            const sessionSettings = {
                auto_logout: document.getElementById('auto_logout').checked,
                session_timeout: document.getElementById('session_timeout').value
            };
            
            const response = await apiRequest('settings/security/session/', 'PUT', sessionSettings);
            if (response) {
                showNotification('Success', 'Session settings saved successfully', 'success');
            }
        } catch (error) {
            console.error('Error saving session settings:', error);
            showNotification('Error', 'Failed to save session settings', 'danger');
        }
    }
    
    // Save appearance settings
    async function saveAppearanceSettings() {
        try {
            const themeValue = document.querySelector('input[name="theme"]:checked').value;
            
            const appearanceSettings = {
                theme: themeValue,
                color_scheme: document.getElementById('color_scheme').value,
                font_size: document.getElementById('font_size').value,
                compact_view: document.getElementById('compact_view').checked
            };
            
            const response = await apiRequest('settings/appearance/', 'PUT', appearanceSettings);
            if (response) {
                showNotification('Success', 'Appearance settings saved successfully', 'success');
                
                // Apply theme changes immediately
                applyTheme(appearanceSettings);
            }
        } catch (error) {
            console.error('Error saving appearance settings:', error);
            showNotification('Error', 'Failed to save appearance settings', 'danger');
        }
    }
    
    // Reset appearance settings to default
    function resetAppearanceSettings() {
        // Set default values
        document.getElementById('theme_light').checked = true;
        document.getElementById('color_scheme').value = 'blue';
        document.getElementById('font_size').value = 'medium';
        document.getElementById('compact_view').checked = false;
        
        // Save the default settings
        saveAppearanceSettings();
    }
    
    // Apply theme changes
    function applyTheme(settings) {
        // This function would apply theme changes to the UI
        // This is a placeholder - actual implementation would depend on your theming system
        console.log('Applying theme:', settings);
    }
</script>
{% endblock %}
