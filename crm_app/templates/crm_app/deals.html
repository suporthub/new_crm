{% extends 'crm_app/base.html' %}

{% block title %}Deals - LiveFxHub CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Deals</h1>
    
    <!-- User Stats Section -->
    <div class="row mb-4" id="user-stats">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Total Deals</h5>
                    <h2 class="card-text" id="total-deals-count">0</h2>
                    <p class="card-text"><small>Your active deals</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Conversion Rate</h5>
                    <h2 class="card-text" id="conversion-rate">0%</h2>
                    <p class="card-text"><small>Deals won / Total deals</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Pending Tasks</h5>
                    <h2 class="card-text" id="pending-tasks-count">0</h2>
                    <p class="card-text"><small>Tasks related to deals</small></p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Potential Revenue</h5>
                    <h2 class="card-text" id="potential-revenue">$0</h2>
                    <p class="card-text"><small>From open deals</small></p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Deal Pipeline</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDealModal">
                <i class="fas fa-plus"></i> Add Deal
            </button>
        </div>
        <div class="card-body">
            <div class="pipeline-container" id="deal-pipeline">
                <!-- Pipeline stages will be loaded here via JavaScript -->
                <div class="text-center p-5">
                    {% include 'crm_app/partials/loader.html' %}
                    <p class="mt-2">Loading deal pipeline...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Deals</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="deals-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Account</th>
                            <th>Amount</th>
                            <th>Closing Date</th>
                            <th>Stage</th>
                            <th>Probability</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Deals will be loaded here via JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Loading deals...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Deal Modal -->
<div class="modal fade" id="addDealModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Deal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="deal-form">
                    <div class="mb-3">
                        <label for="name" class="form-label">Deal Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="account" class="form-label">Account <span class="text-danger">*</span></label>
                        <select class="form-select" id="account" name="account" multiple required>
                            <!-- Accounts will be loaded here via JavaScript -->
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple accounts</small>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="amount" class="form-label">Amount <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amount" name="amount" min="0" step="0.01" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="closing_date" class="form-label">Closing Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="closing_date" name="closing_date" required>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="stage" class="form-label">Stage <span class="text-danger">*</span></label>
                            <select class="form-select" id="stage" name="stage" required>
                                <option value="qualification">Qualification</option>
                                <option value="needs_analysis">Needs Analysis</option>
                                <option value="value_proposition">Value Proposition</option>
                                <option value="id_decision_makers">Identify Decision Makers</option>
                                <option value="proposal">Proposal/Price Quote</option>
                                <option value="negotiation">Negotiation/Review</option>
                                <option value="closed_won">Closed Won</option>
                                <option value="closed_lost">Closed Lost</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="probability" class="form-label">Probability (%) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="probability" name="probability" min="0" max="100" value="50" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="contacts" class="form-label">Associated Contacts</label>
                        <select class="form-select" id="contacts" name="contacts" multiple>
                            <!-- Contacts will be loaded here via JavaScript -->
                        </select>
                        <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple contacts</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assigned_to" class="form-label">Assigned To</label>
                        <select class="form-select" id="assigned_to" name="assigned_to">
                            <option value="">Not Assigned</option>
                            <!-- Users will be loaded here via JavaScript -->
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="add_task" name="add_task">
                        <label class="form-check-label" for="add_task">Create follow-up task</label>
                    </div>
                    
                    <div id="task-details" class="border p-3 mb-3" style="display:none;">
                        <h6>Follow-up Task Details</h6>
                        <div class="mb-3">
                            <label for="task_subject" class="form-label">Subject <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="task_subject" name="task_subject">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="task_due_date" class="form-label">Due Date <span class="text-danger">*</span></label>
                                <input type="datetime-local" class="form-control" id="task_due_date" name="task_due_date">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="task_priority" class="form-label">Priority</label>
                                <select class="form-select" id="task_priority" name="task_priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="task_description" class="form-label">Description</label>
                            <textarea class="form-control" id="task_description" name="task_description" rows="2"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-deal-btn">Save Deal</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load deals on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadDeals();
        loadAccounts();
        loadContacts();
        loadUsers();
        loadUserStats();
        
        // Set up save deal button
        document.getElementById('save-deal-btn').addEventListener('click', saveNewDeal);
        
        // Set today as default closing date
        document.getElementById('closing_date').valueAsDate = new Date();
        
        // Toggle task details when checkbox is clicked
        document.getElementById('add_task').addEventListener('change', function() {
            const taskDetails = document.getElementById('task-details');
            if (this.checked) {
                taskDetails.style.display = 'block';
                // Set default due date to tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                tomorrow.setHours(9, 0, 0, 0);
                document.getElementById('task_due_date').valueAsDate = tomorrow;
            } else {
                taskDetails.style.display = 'none';
            }
        });
    });
    
    // Load deals from API
    async function loadDeals() {
        try {
            document.querySelector('#deals-table tbody').innerHTML = 
                '<tr><td colspan="7" class="text-center"><div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div> Loading deals...</td></tr>';
            
            const data = await apiRequest('deals/');
            if (data && data.results) {
                populateDealsTable(data.results);
                populateDealPipeline(data.results);
                updateUserStats(data.results);
            } else if (data && Array.isArray(data)) {
                populateDealsTable(data);
                populateDealPipeline(data);
                updateUserStats(data);
            } else {
                document.querySelector('#deals-table tbody').innerHTML = 
                    '<tr><td colspan="7" class="text-center">No deals found</td></tr>';
                document.getElementById('deal-pipeline').innerHTML = 
                    '<div class="text-center p-5"><p>No deals found</p></div>';
            }
        } catch (error) {
            console.error('Error loading deals:', error);
            document.querySelector('#deals-table tbody').innerHTML = 
                '<tr><td colspan="7" class="text-center">Error loading deals</td></tr>';
            document.getElementById('deal-pipeline').innerHTML = 
                '<div class="text-center p-5"><p>Error loading deal pipeline</p></div>';
        }
    }
    
    // Load accounts for dropdown
    async function loadAccounts() {
        try {
            // First get the current user's profile to get their manager_username
            const userProfile = await apiRequest('profile/');
            const accountSelect = document.getElementById('account');
            
            // Clear existing options except the first one
            while (accountSelect.options.length > 1) {
                accountSelect.remove(1);
            }
            
            if (userProfile && userProfile.manager_username) {
                // Get accounts filtered by manager_username
                const data = await apiRequest(`accounts/?manager_username=${userProfile.manager_username}`);
                
                if (data && data.results) {
                    // Filter accounts to only show those with matching manager_username
                    const managerAccounts = data.results.filter(account => 
                        account.manager_username === userProfile.manager_username
                    );
                    
                    if (managerAccounts.length > 0) {
                        managerAccounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.id;
                            option.textContent = account.name;
                            accountSelect.appendChild(option);
                        });
                    } else {
                        // No accounts with matching manager
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No accounts found';
                        accountSelect.appendChild(option);
                    }
                } else if (data && Array.isArray(data)) {
                    // Filter accounts to only show those with matching manager_username
                    const managerAccounts = data.filter(account => 
                        account.manager_username === userProfile.manager_username
                    );
                    
                    if (managerAccounts.length > 0) {
                        managerAccounts.forEach(account => {
                            const option = document.createElement('option');
                            option.value = account.id;
                            option.textContent = account.name;
                            accountSelect.appendChild(option);
                        });
                    } else {
                        // No accounts with matching manager
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No accounts found';
                        accountSelect.appendChild(option);
                    }
                } else {
                    // No data or unexpected format
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'No accounts found';
                    accountSelect.appendChild(option);
                }
            } else {
                // No manager_username in profile
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No manager assigned';
                accountSelect.appendChild(option);
            }
        } catch (error) {
            console.error('Error loading accounts:', error);
            showNotification('Error', 'Failed to load accounts', 'danger');
        }
    }
    
    // Load contacts for dropdown
    async function loadContacts() {
        try {
            // First get the current user's profile to get their manager_username
            const userProfile = await apiRequest('profile/');
            const contactsSelect = document.getElementById('contacts');
            
            // Clear any existing options
            contactsSelect.innerHTML = '';
            
            if (userProfile && userProfile.manager_username) {
                // Get contacts filtered by manager_username
                const data = await apiRequest(`contacts/?manager_username=${userProfile.manager_username}`);
                
                if (data && data.results) {
                    // Filter contacts to only show those with matching manager_username
                    const managerContacts = data.results.filter(contact => 
                        contact.manager_username === userProfile.manager_username
                    );
                    
                    if (managerContacts.length > 0) {
                        managerContacts.forEach(contact => {
                            const option = document.createElement('option');
                            option.value = contact.id;
                            option.textContent = `${contact.first_name} ${contact.last_name}`;
                            contactsSelect.appendChild(option);
                        });
                    } else {
                        // No contacts with matching manager
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No contacts found';
                        contactsSelect.appendChild(option);
                    }
                } else if (data && Array.isArray(data)) {
                    // Filter contacts to only show those with matching manager_username
                    const managerContacts = data.filter(contact => 
                        contact.manager_username === userProfile.manager_username
                    );
                    
                    if (managerContacts.length > 0) {
                        managerContacts.forEach(contact => {
                            const option = document.createElement('option');
                            option.value = contact.id;
                            option.textContent = `${contact.first_name} ${contact.last_name}`;
                            contactsSelect.appendChild(option);
                        });
                    } else {
                        // No contacts with matching manager
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No contacts found';
                        contactsSelect.appendChild(option);
                    }
                } else {
                    // No data or unexpected format
                    const option = document.createElement('option');
                    option.disabled = true;
                    option.textContent = 'No contacts found';
                    contactsSelect.appendChild(option);
                }
            } else {
                // No manager_username in profile
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = 'No manager assigned';
                contactsSelect.appendChild(option);
            }
        } catch (error) {
            console.error('Error loading contacts:', error);
            const contactsSelect = document.getElementById('contacts');
            const option = document.createElement('option');
            option.disabled = true;
            option.textContent = 'Error loading contacts';
            contactsSelect.appendChild(option);
        }
    }
    
    // Load users for assigned_to dropdown
    async function loadUsers() {
        try {
            // First get the current user's profile to get their manager_username
            const userProfile = await apiRequest('profile/');
            
            if (userProfile && userProfile.manager_username) {
                // Get users by manager
                const data = await apiRequest(`users-by-manager/?manager_username=${userProfile.manager_username}`);
                const userSelect = document.getElementById('assigned_to');
                
                if (data && Array.isArray(data)) {
                    data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.username;
                        userSelect.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }
    
    // Load user stats
    async function loadUserStats() {
        try {
            // Show loading state
            document.getElementById('total-deals-count').textContent = '...';
            document.getElementById('conversion-rate').textContent = '...';
            document.getElementById('pending-tasks-count').textContent = '...';
            document.getElementById('potential-revenue').textContent = '...';
            
            // Get tasks data
            const tasksData = await apiRequest('tasks/');
            let pendingTasks = 0;
            
            if (tasksData && tasksData.results) {
                pendingTasks = tasksData.results.filter(task => 
                    task.related_deal && task.status !== 'completed'
                ).length;
            } else if (tasksData && Array.isArray(tasksData)) {
                pendingTasks = tasksData.filter(task => 
                    task.related_deal && task.status !== 'completed'
                ).length;
            }
            
            document.getElementById('pending-tasks-count').textContent = pendingTasks;
        } catch (error) {
            console.error('Error loading user stats:', error);
            document.getElementById('pending-tasks-count').textContent = 'Error';
        }
    }
    
    // Update user stats based on deals data
    function updateUserStats(deals) {
        if (!deals || deals.length === 0) {
            document.getElementById('total-deals-count').textContent = '0';
            document.getElementById('conversion-rate').textContent = '0%';
            document.getElementById('potential-revenue').textContent = '$0';
            return;
        }
        
        // Total deals
        document.getElementById('total-deals-count').textContent = deals.length;
        
        // Conversion rate
        const closedWonDeals = deals.filter(deal => deal.stage === 'closed_won').length;
        const closedDeals = deals.filter(deal => 
            deal.stage === 'closed_won' || deal.stage === 'closed_lost'
        ).length;
        
        let conversionRate = 0;
        if (closedDeals > 0) {
            conversionRate = Math.round((closedWonDeals / closedDeals) * 100);
        }
        document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
        
        // Potential revenue
        const openDeals = deals.filter(deal => 
            deal.stage !== 'closed_won' && deal.stage !== 'closed_lost'
        );
        const potentialRevenue = openDeals.reduce((total, deal) => {
            return total + (parseFloat(deal.amount) || 0);
        }, 0);
        
        document.getElementById('potential-revenue').textContent = 
            `$${potentialRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
    }
    
    // Populate deals table
    function populateDealsTable(deals) {
        const tableBody = document.getElementById('deals-table').getElementsByTagName('tbody')[0];
        if (!deals || deals.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No deals found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        deals.forEach(deal => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${deal.name}</td>
                <td>${deal.account_name}</td>
                <td>$${deal.amount}</td>
                <td>${formatDate(deal.closing_date)}</td>
                <td><span class="badge bg-${getDealStageColor(deal.stage)}">${deal.stage_display || getDealStageDisplay(deal.stage)}</span></td>
                <td>${deal.probability}%</td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="viewDeal(${deal.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="editDeal(${deal.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteDeal(${deal.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Populate deal pipeline
    function populateDealPipeline(deals) {
        const pipelineContainer = document.getElementById('deal-pipeline');
        
        // Define stages
        const stages = [
            { code: 'qualification', name: 'Qualification' },
            { code: 'needs_analysis', name: 'Needs Analysis' },
            { code: 'value_proposition', name: 'Value Proposition' },
            { code: 'id_decision_makers', name: 'Identify Decision Makers' },
            { code: 'proposal', name: 'Proposal' },
            { code: 'negotiation', name: 'Negotiation' },
            { code: 'closed_won', name: 'Closed Won' },
            { code: 'closed_lost', name: 'Closed Lost' }
        ];
        
        // Group deals by stage
        const dealsByStage = {};
        stages.forEach(stage => {
            dealsByStage[stage.code] = deals.filter(deal => deal.stage === stage.code);
        });
        
        // Create pipeline HTML
        pipelineContainer.innerHTML = '';
        stages.forEach(stage => {
            const stageDeals = dealsByStage[stage.code] || [];
            const stageElement = document.createElement('div');
            stageElement.className = 'pipeline-stage';
            
            // Stage header
            const stageHeader = document.createElement('div');
            stageHeader.className = 'pipeline-stage-header';
            stageHeader.innerHTML = `
                <h6>${stage.name}</h6>
                <div class="d-flex justify-content-between">
                    <span>${stageDeals.length} deals</span>
                    <span>$${calculateStageTotal(stageDeals)}</span>
                </div>
            `;
            stageElement.appendChild(stageHeader);
            
            // Stage deals
            stageDeals.forEach(deal => {
                const dealCard = document.createElement('div');
                dealCard.className = 'pipeline-card';
                dealCard.onclick = () => viewDeal(deal.id);
                dealCard.innerHTML = `
                    <h6>${deal.name}</h6>
                    <div class="small text-muted">${deal.account_name}</div>
                    <div class="d-flex justify-content-between mt-2">
                        <span>$${deal.amount}</span>
                        <span>${formatDate(deal.closing_date)}</span>
                    </div>
                `;
                stageElement.appendChild(dealCard);
            });
            
            pipelineContainer.appendChild(stageElement);
        });
    }
    
    // Calculate total amount for deals in a stage
    function calculateStageTotal(deals) {
        return deals.reduce((total, deal) => total + parseFloat(deal.amount), 0).toLocaleString();
    }
    
    // Save new deal
    async function saveNewDeal() {
        try {
            // Show loading state
            const saveBtn = document.getElementById('save-deal-btn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
            saveBtn.disabled = true;
            
            const form = document.getElementById('deal-form');
            
            // Validate required fields
            if (!form.checkValidity()) {
                form.reportValidity();
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
                return;
            }
            
            // Prepare form data
            const formData = {};
            
            // Basic deal data
            formData.name = document.getElementById('name').value;
            
            // Handle multiple account selection
            const accountSelect = document.getElementById('account');
            const selectedAccounts = Array.from(accountSelect.selectedOptions).map(option => option.value);
            
            if (selectedAccounts.length === 0) {
                showNotification('Error', 'Please select at least one account', 'danger');
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
                return;
            }
            
            // For now, use the first selected account (API might need updating to handle multiple accounts)
            formData.account = selectedAccounts[0];
            
            // Store all selected accounts for future reference
            formData.selected_accounts = selectedAccounts;
            
            formData.amount = document.getElementById('amount').value;
            formData.closing_date = document.getElementById('closing_date').value;
            formData.stage = document.getElementById('stage').value;
            formData.probability = document.getElementById('probability').value;
            formData.description = document.getElementById('description').value;
            
            // Assigned to (if selected)
            const assignedTo = document.getElementById('assigned_to').value;
            if (assignedTo) {
                formData.assigned_to = assignedTo;
            }
            
            // Associated contacts (if any selected)
            const contactsSelect = document.getElementById('contacts');
            const selectedContacts = Array.from(contactsSelect.selectedOptions).map(option => option.value);
            if (selectedContacts.length > 0) {
                formData.contacts = selectedContacts;
            }
            
            // Create deal
            const dealData = await apiRequest('deals/', 'POST', formData);
            
            if (!dealData) {
                throw new Error('Failed to create deal');
            }
            
            // If add task is checked, create a follow-up task
            if (document.getElementById('add_task').checked) {
                const taskData = {
                    subject: document.getElementById('task_subject').value,
                    due_date: document.getElementById('task_due_date').value,
                    priority: document.getElementById('task_priority').value,
                    description: document.getElementById('task_description').value,
                    related_deal: dealData.id,
                    assigned_to: formData.assigned_to || JSON.parse(localStorage.getItem('user')).id
                };
                
                await apiRequest('tasks/', 'POST', taskData);
            }
            
            // Close modal and reload deals
            const modal = bootstrap.Modal.getInstance(document.getElementById('addDealModal'));
            modal.hide();
            form.reset();
            
            // Reset task details display
            document.getElementById('add_task').checked = false;
            document.getElementById('task-details').style.display = 'none';
            
            // Reload deals and show success message
            loadDeals();
            showNotification('Success', 'Deal created successfully');
        } catch (error) {
            console.error('Error saving deal:', error);
            showNotification('Error', 'Failed to create deal. Please try again.', 'danger');
        } finally {
            // Reset button state
            const saveBtn = document.getElementById('save-deal-btn');
            saveBtn.innerHTML = 'Save Deal';
            saveBtn.disabled = false;
        }
    }
    
    // Helper function for deal stage color
    function getDealStageColor(stage) {
        switch (stage) {
            case 'qualification': return 'primary';
            case 'needs_analysis': return 'info';
            case 'value_proposition': return 'secondary';
            case 'id_decision_makers': return 'dark';
            case 'proposal': return 'warning';
            case 'negotiation': return 'light text-dark';
            case 'closed_won': return 'success';
            case 'closed_lost': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Helper function for deal stage display
    function getDealStageDisplay(stage) {
        switch (stage) {
            case 'qualification': return 'Qualification';
            case 'needs_analysis': return 'Needs Analysis';
            case 'value_proposition': return 'Value Proposition';
            case 'id_decision_makers': return 'Identify Decision Makers';
            case 'proposal': return 'Proposal';
            case 'negotiation': return 'Negotiation';
            case 'closed_won': return 'Closed Won';
            case 'closed_lost': return 'Closed Lost';
            default: return stage;
        }
    }
    
    // View deal details
    function viewDeal(id) {
        // Implement view deal functionality
        console.log('View deal:', id);
    }
    
    // Edit deal
    function editDeal(id) {
        // Implement edit deal functionality
        console.log('Edit deal:', id);
    }
    
    // Delete deal
    function deleteDeal(id) {
        // Implement delete deal functionality
        if (confirm('Are you sure you want to delete this deal?')) {
            apiRequest(`deals/${id}/`, 'DELETE')
                .then(() => {
                    loadDeals();
                    showNotification('Success', 'Deal deleted successfully');
                });
        }
    }
</script>
{% endblock %}
