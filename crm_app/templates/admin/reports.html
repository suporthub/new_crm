{% extends 'admin/base_admin.html' %}
{% load static %}

{% block title %}Reports Dashboard - LiveFxHub CRM Admin{% endblock %}

{% block page_title %}Reports Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Report Selection -->
    <div class="admin-card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Generate Reports</h5>
            <div>
                <button class="btn btn-sm btn-outline-primary me-2" id="saveReportBtn">
                    <i class="fas fa-save me-1"></i> Save Report
                </button>
                <button class="btn btn-sm btn-outline-success me-2" id="exportReportBtn">
                    <i class="fas fa-file-export me-1"></i> Export
                </button>
                <button class="btn btn-sm btn-primary" id="printReportBtn">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Report Type</label>
                        <select class="form-select" id="reportType">
                            <option value="sales">Sales Report</option>
                            <option value="leads">Lead Conversion Report</option>
                            <option value="accounts">Account Activity Report</option>
                            <option value="users">User Performance Report</option>
                            <option value="products">Product Sales Report</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="reportPeriod" class="form-label">Time Period</label>
                        <select class="form-select" id="reportPeriod">
                            <option value="today">Today</option>
                            <option value="yesterday">Yesterday</option>
                            <option value="this_week">This Week</option>
                            <option value="last_week">Last Week</option>
                            <option value="this_month">This Month</option>
                            <option value="last_month">Last Month</option>
                            <option value="this_quarter">This Quarter</option>
                            <option value="last_quarter">Last Quarter</option>
                            <option value="this_year">This Year</option>
                            <option value="last_year">Last Year</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label for="reportDateRange" class="form-label">Custom Date Range</label>
                        <input type="text" class="form-control" id="reportDateRange" placeholder="Select date range" disabled>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="mb-3">
                        <label for="generateReportBtn" class="form-label">&nbsp;</label>
                        <button id="generateReportBtn" class="btn btn-primary w-100">
                            <i class="fas fa-chart-line me-2"></i> Generate
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sales Report (default) -->
    <div id="salesReportSection" class="report-section">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="admin-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 p-3 me-3">
                            <i class="fas fa-chart-line fa-2x text-primary"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Total Sales</h6>
                            <h3 class="mb-0">${{ total_sales|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-10 p-3 me-3">
                            <i class="fas fa-shopping-cart fa-2x text-success"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Deals Closed</h6>
                            <h3 class="mb-0">{{ deals_closed }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="rounded-circle bg-warning bg-opacity-10 p-3 me-3">
                            <i class="fas fa-percentage fa-2x text-warning"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">Avg. Deal Size</h6>
                            <h3 class="mb-0">${{ avg_deal_size|floatformat:2 }}</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="admin-card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div class="rounded-circle bg-info bg-opacity-10 p-3 me-3">
                            <i class="fas fa-users fa-2x text-info"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">New Customers</h6>
                            <h3 class="mb-0">{{ new_customers }}</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="admin-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sales Trend</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="salesTrendChart" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="admin-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sales by Product Category</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="salesByCategoryChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="admin-card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Top Performing Products</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover admin-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Units Sold</th>
                                <th>Revenue</th>
                                <th>% of Total</th>
                                <th>Trend</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="product-image rounded me-2" style="width: 32px; height: 32px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                            {% if product.image %}
                                            <img src="{{ product.image.url }}" alt="{{ product.name }}" style="max-width: 100%; max-height: 100%;">
                                            {% else %}
                                            <i class="fas fa-box text-secondary"></i>
                                            {% endif %}
                                        </div>
                                        <div>{{ product.name }}</div>
                                    </div>
                                </td>
                                <td>{{ product.category }}</td>
                                <td>{{ product.units_sold }}</td>
                                <td>${{ product.revenue|floatformat:2 }}</td>
                                <td>{{ product.percentage }}%</td>
                                <td>
                                    {% if product.trend > 0 %}
                                    <span class="text-success"><i class="fas fa-arrow-up me-1"></i>{{ product.trend }}%</span>
                                    {% elif product.trend < 0 %}
                                    <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ product.trend_abs }}%</span>
                                    {% else %}
                                    <span class="text-muted"><i class="fas fa-minus me-1"></i>0%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="admin-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sales by Account</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover admin-table">
                                <thead>
                                    <tr>
                                        <th>Account</th>
                                        <th>Revenue</th>
                                        <th>Deals</th>
                                        <th>Trend</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for account in top_accounts %}
                                    <tr>
                                        <td>{{ account.name }}</td>
                                        <td>${{ account.revenue|floatformat:2 }}</td>
                                        <td>{{ account.deals }}</td>
                                        <td>
                                            {% if account.trend > 0 %}
                                            <span class="text-success"><i class="fas fa-arrow-up me-1"></i>{{ account.trend }}%</span>
                                            {% elif account.trend < 0 %}
                                            <span class="text-danger"><i class="fas fa-arrow-down me-1"></i>{{ account.trend_abs }}%</span>
                                            {% else %}
                                            <span class="text-muted"><i class="fas fa-minus me-1"></i>0%</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="admin-card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Sales by Region</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="salesByRegionChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Date Range Picker
        $('#reportDateRange').daterangepicker({
            autoUpdateInput: false,
            locale: {
                cancelLabel: 'Clear'
            }
        });
        
        $('#reportDateRange').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
        });
        
        $('#reportDateRange').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
        });
        
        // Toggle custom date range input based on report period selection
        $('#reportPeriod').on('change', function() {
            if ($(this).val() === 'custom') {
                $('#reportDateRange').prop('disabled', false);
            } else {
                $('#reportDateRange').prop('disabled', true);
                $('#reportDateRange').val('');
            }
        });
        
        // Sales Trend Chart
        const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
        const salesTrendChart = new Chart(salesTrendCtx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                datasets: [{
                    label: 'This Year',
                    data: [12000, 15000, 18000, 14000, 17000, 19000, 16000, 20000, 22000, 18000, 20000, 25000],
                    borderColor: 'rgba(52, 152, 219, 1)',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }, {
                    label: 'Last Year',
                    data: [10000, 12000, 14000, 11000, 13000, 15000, 12000, 16000, 18000, 15000, 17000, 20000],
                    borderColor: 'rgba(149, 165, 166, 1)',
                    backgroundColor: 'rgba(149, 165, 166, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Sales by Category Chart
        const salesByCategoryCtx = document.getElementById('salesByCategoryChart').getContext('2d');
        const salesByCategoryChart = new Chart(salesByCategoryCtx, {
            type: 'doughnut',
            data: {
                labels: ['Electronics', 'Services', 'Software', 'Hardware', 'Other'],
                datasets: [{
                    data: [35, 25, 20, 15, 5],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(149, 165, 166, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(149, 165, 166, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
        
        // Sales by Region Chart
        const salesByRegionCtx = document.getElementById('salesByRegionChart').getContext('2d');
        const salesByRegionChart = new Chart(salesByRegionCtx, {
            type: 'bar',
            data: {
                labels: ['North America', 'Europe', 'Asia', 'Australia', 'South America', 'Africa'],
                datasets: [{
                    label: 'Sales by Region',
                    data: [45000, 32000, 28000, 18000, 12000, 5000],
                    backgroundColor: [
                        'rgba(52, 152, 219, 0.7)',
                        'rgba(46, 204, 113, 0.7)',
                        'rgba(155, 89, 182, 0.7)',
                        'rgba(241, 196, 15, 0.7)',
                        'rgba(230, 126, 34, 0.7)',
                        'rgba(149, 165, 166, 0.7)'
                    ],
                    borderColor: [
                        'rgba(52, 152, 219, 1)',
                        'rgba(46, 204, 113, 1)',
                        'rgba(155, 89, 182, 1)',
                        'rgba(241, 196, 15, 1)',
                        'rgba(230, 126, 34, 1)',
                        'rgba(149, 165, 166, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            drawBorder: false
                        },
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                }
            }
        });
        
        // Generate Report Button
        document.getElementById('generateReportBtn').addEventListener('click', function() {
            const reportType = document.getElementById('reportType').value;
            const reportPeriod = document.getElementById('reportPeriod').value;
            const reportDateRange = document.getElementById('reportDateRange').value;
            
            // In a real implementation, this would trigger an API call to generate the report
            showNotification('Info', 'Generating report...', 'info');
            setTimeout(() => {
                showNotification('Success', 'Report generated successfully!', 'success');
            }, 1500);
        });
        
        // Export Report Button
        document.getElementById('exportReportBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Show dropdown with export options
            const exportOptions = ['PDF', 'Excel', 'CSV'];
            const exportFormat = prompt('Select export format: PDF, Excel, CSV');
            
            if (exportFormat && exportOptions.map(opt => opt.toLowerCase()).includes(exportFormat.toLowerCase())) {
                showNotification('Success', `Report exported as ${exportFormat} successfully!`, 'success');
                
                // Simulate file download
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = '#';
                    link.download = `sales_report.${exportFormat.toLowerCase()}`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, 1000);
            } else if (exportFormat) {
                showNotification('Error', 'Invalid export format selected', 'error');
            }
        });
        
        // Print Report Button
        document.getElementById('printReportBtn').addEventListener('click', function() {
            showNotification('Info', 'Preparing report for printing...', 'info');
            setTimeout(() => {
                window.print();
            }, 1000);
        });
        
        // Save Report Button
        document.getElementById('saveReportBtn').addEventListener('click', function() {
            const reportName = prompt('Enter a name for this report:');
            if (reportName) {
                showNotification('Success', `Report "${reportName}" saved successfully!`, 'success');
            }
        });
    });
    
    // Notification function
    function showNotification(title, message, type = 'success') {
        const icon = type === 'success' ? 'check-circle' :
                    type === 'warning' ? 'exclamation-triangle' :
                    type === 'error' ? 'times-circle' : 'info-circle';
        
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-white bg-${type} border-0`;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'assertive');
        toast.setAttribute('aria-atomic', 'true');
        
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${icon} me-2"></i>
                    <strong>${title}:</strong> ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            container.style.zIndex = '5';
            document.body.appendChild(container);
            container.appendChild(toast);
        } else {
            toastContainer.appendChild(toast);
        }
        
        const bsToast = new bootstrap.Toast(toast, {
            animation: true,
            autohide: true,
            delay: 5000
        });
        
        bsToast.show();
        
        // Remove toast from DOM after it's hidden
        toast.addEventListener('hidden.bs.toast', function() {
            toast.remove();
        });
    }
</script>
{% endblock %}
