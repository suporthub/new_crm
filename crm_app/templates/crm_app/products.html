{% extends 'crm_app/base.html' %}

{% block title %}Products - LiveFxHub CRM{% endblock %}

{% block content %}
<div class="container-fluid">
    <h1 class="mb-4">Products</h1>
    
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">All Products</h5>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="fas fa-plus"></i> Add Product
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <div class="input-group">
                    <input type="text" class="form-control" id="product-search" placeholder="Search products...">
                    <button class="btn btn-outline-secondary" type="button" id="product-search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover" id="products-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>SKU</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Stock</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Products will be loaded here via JavaScript -->
                        <tr>
                            <td colspan="7" class="text-center">Loading products...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                    <span id="showing-entries">Showing 0 to 0 of 0 entries</span>
                </div>
                <nav aria-label="Product pagination">
                    <ul class="pagination" id="product-pagination">
                        <!-- Pagination will be added here via JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="name" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="sku" class="form-label">SKU</label>
                            <input type="text" class="form-control" id="sku" name="sku" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="category" class="form-label">Category</label>
                            <select class="form-select" id="category" name="category">
                                <option value="">Select Category</option>
                                <option value="hardware">Hardware</option>
                                <option value="software">Software</option>
                                <option value="service">Service</option>
                                <option value="subscription">Subscription</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="unit" class="form-label">Unit</label>
                            <select class="form-select" id="unit" name="unit">
                                <option value="piece">Piece</option>
                                <option value="box">Box</option>
                                <option value="kg">Kilogram</option>
                                <option value="license">License</option>
                                <option value="service">Service</option>
                                <option value="subscription">Subscription</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="price" class="form-label">Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="cost" class="form-label">Cost</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="cost" name="cost" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="stock" class="form-label">Stock Quantity</label>
                            <input type="number" class="form-control" id="stock" name="stock" min="0">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Status</label>
                            <select class="form-select" id="status" name="status">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="discontinued">Discontinued</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="product-image" class="form-label">Product Image</label>
                        <input type="file" class="form-control" id="product-image" name="image" accept="image/*">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-product-btn">Save Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="product-detail-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <img id="product-detail-image" src="" alt="Product Image" class="img-fluid rounded mb-3" style="max-height: 200px;">
                    </div>
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="fw-bold">SKU:</label>
                            <div id="product-detail-sku"></div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Category:</label>
                            <div id="product-detail-category"></div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Price:</label>
                            <div id="product-detail-price"></div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Stock:</label>
                            <div id="product-detail-stock"></div>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold">Status:</label>
                            <div id="product-detail-status"></div>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Description:</label>
                    <div id="product-detail-description"></div>
                </div>
                <div class="mb-3">
                    <label class="fw-bold">Related Deals:</label>
                    <div id="product-detail-deals">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Deal</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="product-detail-deals-table">
                                <!-- Deal data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="edit-product-btn">Edit</button>
                <button type="button" class="btn btn-danger" id="delete-product-btn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let currentProduct = null;
    
    // Load products on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadProducts();
        
        // Set up search button
        document.getElementById('product-search-btn').addEventListener('click', function() {
            loadProducts(1, document.getElementById('product-search').value);
        });
        
        // Set up search input enter key
        document.getElementById('product-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadProducts(1, this.value);
            }
        });
        
        // Set up save product button
        document.getElementById('save-product-btn').addEventListener('click', saveProduct);
        
        // Set up edit product button
        document.getElementById('edit-product-btn').addEventListener('click', function() {
            if (currentProduct) {
                // Close details modal
                const detailsModal = bootstrap.Modal.getInstance(document.getElementById('productDetailsModal'));
                detailsModal.hide();
                
                // Open edit modal with product data
                editProduct(currentProduct.id);
            }
        });
        
        // Set up delete product button
        document.getElementById('delete-product-btn').addEventListener('click', function() {
            if (currentProduct) {
                if (confirm('Are you sure you want to delete this product?')) {
                    deleteProduct(currentProduct.id);
                }
            }
        });
    });
    
    // Load products from API
    async function loadProducts(page = 1, search = '') {
        currentPage = page;
        
        let url = `products/?page=${page}`;
        if (search) {
            url += `&search=${encodeURIComponent(search)}`;
        }
        
        const data = await apiRequest(url);
        if (data) {
            populateProductsTable(data.results);
            updatePagination(data.count, data.page_size);
        }
    }
    
    // Populate products table
    function populateProductsTable(products) {
        const tableBody = document.getElementById('products-table').getElementsByTagName('tbody')[0];
        if (!products || products.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center">No products found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        products.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${product.name}</td>
                <td>${product.sku}</td>
                <td>${product.category_display || product.category || 'N/A'}</td>
                <td>$${parseFloat(product.price).toFixed(2)}</td>
                <td>${product.stock !== null ? product.stock : 'N/A'}</td>
                <td><span class="badge bg-${getProductStatusColor(product.status)}">${product.status_display || product.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-info me-1" onclick="viewProduct(${product.id})">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-primary me-1" onclick="editProduct(${product.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDeleteProduct(${product.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Update pagination
    function updatePagination(totalItems, pageSize) {
        const paginationEl = document.getElementById('product-pagination');
        const showingEntriesEl = document.getElementById('showing-entries');
        
        // Calculate total pages
        totalPages = Math.ceil(totalItems / pageSize);
        
        // Update showing entries text
        const startItem = (currentPage - 1) * pageSize + 1;
        const endItem = Math.min(currentPage * pageSize, totalItems);
        showingEntriesEl.textContent = `Showing ${startItem} to ${endItem} of ${totalItems} entries`;
        
        // Generate pagination
        paginationEl.innerHTML = '';
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" aria-label="Previous" ${currentPage > 1 ? `onclick="loadProducts(${currentPage - 1})"` : ''}><span aria-hidden="true">&laquo;</span></a>`;
        paginationEl.appendChild(prevLi);
        
        // Page numbers
        const maxPages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
        let endPage = Math.min(totalPages, startPage + maxPages - 1);
        
        if (endPage - startPage + 1 < maxPages) {
            startPage = Math.max(1, endPage - maxPages + 1);
        }
        
        for (let i = startPage; i <= endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
            pageLi.innerHTML = `<a class="page-link" href="#" onclick="loadProducts(${i})">${i}</a>`;
            paginationEl.appendChild(pageLi);
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" aria-label="Next" ${currentPage < totalPages ? `onclick="loadProducts(${currentPage + 1})"` : ''}><span aria-hidden="true">&raquo;</span></a>`;
        paginationEl.appendChild(nextLi);
    }
    
    // Save product
    async function saveProduct() {
        const form = document.getElementById('product-form');
        const formData = new FormData(form);
        
        const data = await apiRequest('products/', 'POST', formData, true);
        if (data) {
            // Close modal and reload products
            const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModal'));
            modal.hide();
            form.reset();
            loadProducts();
            showNotification('Success', 'Product created successfully');
        }
    }
    
    // View product details
    async function viewProduct(id) {
        const data = await apiRequest(`products/${id}/`);
        if (data) {
            currentProduct = data;
            
            // Populate modal
            document.getElementById('product-detail-title').textContent = data.name;
            document.getElementById('product-detail-sku').textContent = data.sku;
            document.getElementById('product-detail-category').textContent = data.category_display || data.category || 'N/A';
            document.getElementById('product-detail-price').textContent = `$${parseFloat(data.price).toFixed(2)}`;
            document.getElementById('product-detail-stock').textContent = data.stock !== null ? data.stock : 'N/A';
            
            // Status badge
            const statusEl = document.getElementById('product-detail-status');
            statusEl.innerHTML = `<span class="badge bg-${getProductStatusColor(data.status)}">${data.status_display || data.status}</span>`;
            
            // Description
            document.getElementById('product-detail-description').textContent = data.description || 'No description available';
            
            // Image
            const imageEl = document.getElementById('product-detail-image');
            if (data.image) {
                imageEl.src = data.image;
                imageEl.style.display = 'block';
            } else {
                imageEl.src = '/static/img/product-placeholder.png';
                imageEl.style.display = 'block';
            }
            
            // Load related deals
            loadProductDeals(id);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('productDetailsModal'));
            modal.show();
        }
    }
    
    // Load product deals
    async function loadProductDeals(productId) {
        const data = await apiRequest(`products/${productId}/deals/`);
        const tableBody = document.getElementById('product-detail-deals-table');
        
        if (!data || !data.results || data.results.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center">No related deals found</td></tr>';
            return;
        }
        
        tableBody.innerHTML = '';
        data.results.forEach(deal => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href="#" onclick="viewDeal(${deal.deal_id})">${deal.deal_name}</a></td>
                <td>${deal.quantity}</td>
                <td>$${parseFloat(deal.total_amount).toFixed(2)}</td>
                <td><span class="badge bg-${getDealStatusColor(deal.deal_status)}">${deal.deal_status}</span></td>
            `;
            tableBody.appendChild(row);
        });
    }
    
    // Edit product
    function editProduct(id) {
        // Implement edit product functionality
        console.log('Edit product:', id);
    }
    
    // Confirm delete product
    function confirmDeleteProduct(id) {
        if (confirm('Are you sure you want to delete this product?')) {
            deleteProduct(id);
        }
    }
    
    // Delete product
    async function deleteProduct(id) {
        const data = await apiRequest(`products/${id}/`, 'DELETE');
        
        // Close modal if open
        const modal = bootstrap.Modal.getInstance(document.getElementById('productDetailsModal'));
        if (modal) {
            modal.hide();
        }
        
        // Reload products
        loadProducts(currentPage);
        showNotification('Success', 'Product deleted successfully');
    }
    
    // View deal
    function viewDeal(id) {
        // Redirect to deal details page
        window.location.href = `/deals/${id}/`;
    }
    
    // Helper function for product status color
    function getProductStatusColor(status) {
        switch (status) {
            case 'active': return 'success';
            case 'inactive': return 'secondary';
            case 'discontinued': return 'danger';
            default: return 'secondary';
        }
    }
    
    // Helper function for deal status color
    function getDealStatusColor(status) {
        switch (status) {
            case 'qualification': return 'secondary';
            case 'needs_analysis': return 'info';
            case 'value_proposition': return 'primary';
            case 'decision_makers': return 'warning';
            case 'proposal': return 'dark';
            case 'negotiation': return 'light';
            case 'closed_won': return 'success';
            case 'closed_lost': return 'danger';
            default: return 'secondary';
        }
    }
</script>
{% endblock %}
